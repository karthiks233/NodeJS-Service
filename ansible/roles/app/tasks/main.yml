---
# ---------------------------------------------------------------
# Install Node.js from NodeSource
# ---------------------------------------------------------------
- name: Install prerequisite packages
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - libcap2-bin
    state: present
    update_cache: true

- name: Add NodeSource GPG key
  shell: |
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \
      | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  args:
    creates: /etc/apt/keyrings/nodesource.gpg

- name: Add NodeSource repository
  copy:
    dest: /etc/apt/sources.list.d/nodesource.list
    content: |
      deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ node_major }}.x nodistro main

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: true

# ---------------------------------------------------------------
# Deploy the Express application
# ---------------------------------------------------------------
- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Copy NodeService app files
  copy:
    src: "{{ playbook_dir }}/../NodeService/"
    dest: "{{ app_dir }}/"
    owner: ubuntu
    group: ubuntu
  notify: restart nodeapp

- name: Install npm dependencies
  npm:
    path: "{{ app_dir }}"
    state: present
  become_user: ubuntu

- name: Allow node to bind to privileged ports (e.g. port 80)
  capabilities:
    path: /usr/bin/node
    capability: cap_net_bind_service+ep
    state: present

# ---------------------------------------------------------------
# Create and start a systemd service
# ---------------------------------------------------------------
- name: Create systemd service for Node.js app
  copy:
    dest: /etc/systemd/system/nodeapp.service
    content: |
      [Unit]
      Description=Node.js Hello World App
      After=network.target

      [Service]
      Type=simple
      User=ubuntu
      WorkingDirectory={{ app_dir }}
      ExecStart=/usr/bin/node {{ app_dir }}/app.js
      Restart=on-failure
      Environment=PORT=80
      Environment=NODE_ENV=production

      [Install]
      WantedBy=multi-user.target
  notify: restart nodeapp

- name: Start Node.js app at boot
  systemd:
    name: nodeapp
    enabled: true
